<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenAPI Swagger UI</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist/swagger-ui.css">
    <style>
        #pod-id-input-container, #auth-token-input-container {
            margin: 10px;
        }
        #pod-id-input, #auth-token-input {
            padding: 5px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="pod-id-input-container">
        <label for="pod-id-input">Pod ID: </label>
        <input type="text" id="pod-id-input" placeholder="Enter Pod ID" value="c522b421-9b64-42b0-a73d-b75fb7854a2e" />
    </div>
    <div id="auth-token-input-container">
        <label for="auth-token-input">Auth Token: </label>
        <input type="text" id="auth-token-input" placeholder="Enter Auth Token" />
    </div>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist/swagger-ui-standalone-preset.js"></script>
    <script>
        window.onload = function() {
            const schema = JSON.parse('{{ schema|escapejs }}');
            const gatewayUrl = 'http://127.0.0.1:8000';

            // Replace all server URLs with the gateway URL
            if (schema.servers) {
                schema.servers.forEach(server => {
                    server.url = gatewayUrl;
                });
            }

            // Replace any URLs in the paths
            for (const path in schema.paths) {
                for (const method in schema.paths[path]) {
                    const operation = schema.paths[path][method];
                    if (operation.servers) {
                        operation.servers.forEach(server => {
                            server.url = gatewayUrl;
                        });
                    }
                }
            }

            const ui = SwaggerUIBundle({
                spec: schema,
                dom_id: '#swagger-ui',
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                layout: "StandaloneLayout",
                requestInterceptor: (request) => {
                    const podId = document.getElementById('pod-id-input').value;
                    const authToken = document.getElementById('auth-token-input').value;
                    if (podId) {
                        // Append Pod-ID as a query parameter
                        const url = new URL(request.url);
                        url.searchParams.append('pod_id', podId);
                        request.url = url.toString();
                    }
                    if (authToken) {
                        request.headers['Authorization'] = `Bearer ${authToken}`;
                    }
                    return request;
                }
            });

            window.ui = ui;
        }
    </script>
</body>
</html>
